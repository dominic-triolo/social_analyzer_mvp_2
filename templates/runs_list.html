{% extends "base.html" %}
{% set active_page = "runs" %}

{% block title %}Pipeline Runs{% endblock %}
{% block page_title %}Pipeline Runs{% endblock %}

{% block top_actions %}
<a href="/discovery" class="btn-accent">+ New Run</a>
{% endblock %}

{% block content %}
<div class="mb-5 animate-in">
    <h1 class="text-xl font-bold" style="color:#005c69;">Pipeline Runs</h1>
    <p class="text-sm mt-0.5" style="color:#3c4858;opacity:0.6;">All discovery &amp; enrichment runs across platforms</p>
</div>

{% if error %}
<div class="card p-6 text-center" style="color:#f65c4e;">
    <div class="text-sm font-medium">{{ error }}</div>
</div>
{% endif %}

<!-- Filter bar -->
<div class="flex flex-wrap items-center gap-2 mb-4 animate-in" style="animation-delay:0.04s;">
    <div class="chip-group" id="platform-filters">
        <button class="chip active" data-platform="all"
                hx-get="/partials/runs-table"
                hx-vals='js:{platform: "all", status: document.querySelector("#status-filters .chip.active")?.dataset.status || "all"}'
                hx-target="#runs-container"
                hx-swap="innerHTML"
                onclick="setActiveChip(this)">All platforms</button>
        <button class="chip" data-platform="instagram"
                hx-get="/partials/runs-table"
                hx-vals='js:{platform: "instagram", status: document.querySelector("#status-filters .chip.active")?.dataset.status || "all"}'
                hx-target="#runs-container"
                hx-swap="innerHTML"
                onclick="setActiveChip(this)">
            <svg width="12" height="12" viewBox="0 0 16 16" fill="none"><rect x="1.5" y="1.5" width="13" height="13" rx="4" stroke="currentColor" stroke-width="1.5"/><circle cx="8" cy="8" r="3" stroke="currentColor" stroke-width="1.5"/><circle cx="11.8" cy="4.2" r="0.9" fill="currentColor"/></svg>
            Instagram
        </button>
        <button class="chip" data-platform="patreon"
                hx-get="/partials/runs-table"
                hx-vals='js:{platform: "patreon", status: document.querySelector("#status-filters .chip.active")?.dataset.status || "all"}'
                hx-target="#runs-container"
                hx-swap="innerHTML"
                onclick="setActiveChip(this)">
            <svg width="12" height="12" viewBox="0 0 16 16" fill="none"><circle cx="10" cy="5.5" r="3.5" stroke="currentColor" stroke-width="1.5"/><rect x="2" y="2" width="2" height="12" rx="1" fill="currentColor" opacity="0.6"/></svg>
            Patreon
        </button>
        <button class="chip" data-platform="facebook"
                hx-get="/partials/runs-table"
                hx-vals='js:{platform: "facebook", status: document.querySelector("#status-filters .chip.active")?.dataset.status || "all"}'
                hx-target="#runs-container"
                hx-swap="innerHTML"
                onclick="setActiveChip(this)">
            <svg width="12" height="12" viewBox="0 0 16 16" fill="none"><path d="M13 2H3V10C3 10.55 3.45 11 4 11H9L13 14V2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Facebook
        </button>
    </div>

    <div class="chip-divider"></div>

    <div class="chip-group" id="status-filters">
        <button class="chip active" data-status="all"
                hx-get="/partials/runs-table"
                hx-vals='js:{platform: document.querySelector("#platform-filters .chip.active")?.dataset.platform || "all", status: "all"}'
                hx-target="#runs-container"
                hx-swap="innerHTML"
                onclick="setActiveChip(this)">Any status</button>
        <button class="chip" data-status="active"
                hx-get="/partials/runs-table"
                hx-vals='js:{platform: document.querySelector("#platform-filters .chip.active")?.dataset.platform || "all", status: "active"}'
                hx-target="#runs-container"
                hx-swap="innerHTML"
                onclick="setActiveChip(this)">Active</button>
        <button class="chip" data-status="completed"
                hx-get="/partials/runs-table"
                hx-vals='js:{platform: document.querySelector("#platform-filters .chip.active")?.dataset.platform || "all", status: "completed"}'
                hx-target="#runs-container"
                hx-swap="innerHTML"
                onclick="setActiveChip(this)">Completed</button>
        <button class="chip" data-status="failed"
                hx-get="/partials/runs-table"
                hx-vals='js:{platform: document.querySelector("#platform-filters .chip.active")?.dataset.platform || "all", status: "failed"}'
                hx-target="#runs-container"
                hx-swap="innerHTML"
                onclick="setActiveChip(this)">Failed</button>
    </div>

    <span class="text-xs ml-auto" style="color:#3c4858;opacity:0.4;" id="runs-count-label"></span>
</div>

<!-- Runs table (HTMX-powered) -->
<div class="card animate-in" style="animation-delay:0.08s;" id="runs-container"
     hx-get="/partials/runs-table"
     hx-trigger="load, every 5s"
     hx-swap="innerHTML"
     hx-vals='js:{platform: document.querySelector("#platform-filters .chip.active")?.dataset.platform || "all", status: document.querySelector("#status-filters .chip.active")?.dataset.status || "all"}'>
    <div class="text-center py-8 text-sm" style="color:#3c4858;opacity:0.35;">Loading runs...</div>
</div>
{% endblock %}

{% block scripts %}
<script>
function setActiveChip(btn) {
    btn.closest('.chip-group').querySelectorAll('.chip').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}
</script>
{% endblock %}
