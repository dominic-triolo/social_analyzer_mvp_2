{% extends "base.html" %}
{% set active_page = "evaluation" %}

{% block title %}Evaluation{% endblock %}
{% block page_title %}Evaluation{% endblock %}

{% block head %}
<style>
    .chart-wrap {
        position: relative;
        padding: 20px;
    }
    .chart-wrap canvas {
        max-height: 320px;
    }
    .eval-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }
    @media (max-width: 900px) {
        .eval-grid { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-5 animate-in">
    <h1 class="text-xl font-bold" style="color:#005c69;">Pipeline Evaluation</h1>
    <p class="text-sm mt-0.5" style="color:#3c4858;opacity:0.6;">Channel performance, funnel health &amp; scoring quality</p>
</div>

<!-- KPI row (loaded via HTMX) -->
<div class="grid grid-cols-3 gap-4 mb-5 animate-in" style="animation-delay:0.04s;" id="kpi-row"
     hx-get="/partials/eval-kpis" hx-trigger="load" hx-swap="innerHTML">
</div>

<!-- Charts (coming soon) -->
<div class="eval-grid animate-in" style="animation-delay:0.08s;">

    <!-- Channel Performance -->
    <div class="card" style="grid-column: 1 / -1;">
        <div class="px-5 pt-4 pb-1">
            <span class="section-label">Channel Performance</span>
        </div>
        <div class="flex items-center justify-center py-12" style="color:#5a6779;opacity:0.4;">
            <p class="text-sm font-medium">Coming soon</p>
        </div>
    </div>

    <!-- Funnel -->
    <div class="card">
        <div class="px-5 pt-4 pb-1">
            <span class="section-label">Funnel Drop-off</span>
        </div>
        <div class="flex items-center justify-center py-12" style="color:#5a6779;opacity:0.4;">
            <p class="text-sm font-medium">Coming soon</p>
        </div>
    </div>

    <!-- Tier Distribution -->
    <div class="card">
        <div class="px-5 pt-4 pb-1">
            <span class="section-label">Tier Distribution</span>
        </div>
        <div class="flex items-center justify-center py-12" style="color:#5a6779;opacity:0.4;">
            <p class="text-sm font-medium">Coming soon</p>
        </div>
    </div>

    <!-- Trends -->
    <div class="card" style="grid-column: 1 / -1;">
        <div class="px-5 pt-4 pb-1">
            <span class="section-label">30-Day Trends</span>
        </div>
        <div class="flex items-center justify-center py-12" style="color:#5a6779;opacity:0.4;">
            <p class="text-sm font-medium">Coming soon</p>
        </div>
    </div>

    <!-- Benchmark Comparison -->
    <div class="card" style="grid-column: 1 / -1;">
        <div class="px-5 pt-4 pb-1">
            <span class="section-label">Benchmark Comparison</span>
        </div>
        <div class="flex items-center justify-center py-12" style="color:#5a6779;opacity:0.4;">
            <p class="text-sm font-medium">Coming soon</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Charts JS disabled while graphs are hidden -->
<!--
<script>
if (!window._evalLoaded) {
window._evalLoaded = true;
(function() {
const COLORS = {
    teal:    '#00b2c9',
    tealDk:  '#005c69',
    coral:   '#f65c4e',
    emerald: '#10b981',
    amber:   '#f59e0b',
    slate:   '#5a6779',
};

const CHART_DEFAULTS = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            labels: { font: { family: 'DM Sans', size: 11, weight: 500 }, color: '#5a6779', boxWidth: 10, padding: 14 }
        }
    },
    scales: {
        x: { ticks: { font: { family: 'DM Sans', size: 11 }, color: '#5a6779' }, grid: { color: 'rgba(60,72,88,0.06)' } },
        y: { ticks: { font: { family: 'DM Sans', size: 11 }, color: '#5a6779' }, grid: { color: 'rgba(60,72,88,0.06)' } },
    }
};

let channelChart, funnelChart, tierChart, trendsChart;

function showEmptyState(canvasId, message) {
    const canvas = document.getElementById(canvasId);
    const wrap = canvas.closest('.chart-wrap');
    canvas.style.display = 'none';
    if (!wrap.querySelector('.empty-state')) {
        const el = document.createElement('div');
        el.className = 'empty-state';
        el.style.cssText = 'display:flex;align-items:center;justify-content:center;min-height:160px;color:#5a6779;opacity:0.5;font-size:13px;font-family:DM Sans,sans-serif;';
        el.textContent = message;
        wrap.appendChild(el);
    }
}

function clearEmptyState(canvasId) {
    const canvas = document.getElementById(canvasId);
    const wrap = canvas.closest('.chart-wrap');
    canvas.style.display = '';
    const empty = wrap.querySelector('.empty-state');
    if (empty) empty.remove();
}

/* ── Channel Performance ──────────────────────────── */
async function loadChannels() {
    const res = await fetch('/api/evaluation/channels');
    const data = await res.json();
    if (data.error || !Array.isArray(data) || data.length === 0) {
        showEmptyState('channelChart', 'No completed runs yet');
        document.getElementById('channel-runs-label').textContent = '0 completed runs';
        return;
    }
    clearEmptyState('channelChart');

    const totalRuns = data.reduce((s, d) => s + d.run_count, 0);
    document.getElementById('channel-runs-label').textContent = totalRuns + ' completed runs';

    const labels = data.map(d => d.platform.charAt(0).toUpperCase() + d.platform.slice(1));
    const ctx = document.getElementById('channelChart').getContext('2d');

    if (channelChart) channelChart.destroy();
    channelChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [
                { label: 'Avg Scored',  data: data.map(d => d.avg_scored), backgroundColor: COLORS.teal,    borderRadius: 4, barPercentage: 0.7 },
                { label: 'Avg Synced',  data: data.map(d => d.avg_synced), backgroundColor: COLORS.tealDk,  borderRadius: 4, barPercentage: 0.7 },
                { label: 'Avg Found',   data: data.map(d => d.avg_found),  backgroundColor: 'rgba(60,72,88,0.12)', borderRadius: 4, barPercentage: 0.7 },
            ]
        },
        options: {
            ...CHART_DEFAULTS,
            indexAxis: 'y',
            plugins: { ...CHART_DEFAULTS.plugins },
        }
    });
}

/* ── Funnel ───────────────────────────────────────── */
async function loadFunnel(platform) {
    const url = '/api/evaluation/funnel' + (platform ? '?platform=' + platform : '');
    const res = await fetch(url);
    const data = await res.json();
    if (data.error || !Array.isArray(data)) {
        showEmptyState('funnelChart', 'No funnel data available');
        return;
    }
    const hasData = data.some(d => d.count > 0);
    if (!hasData) {
        showEmptyState('funnelChart', 'No leads processed yet');
        return;
    }
    clearEmptyState('funnelChart');

    const stageLabels = {
        discovery: 'Discovery', pre_screen: 'Pre-screen', enrichment: 'Enrichment',
        analysis: 'Analysis', scoring: 'Scoring', crm_sync: 'CRM Sync'
    };

    const labels = data.map(d => stageLabels[d.stage] || d.stage);
    const counts = data.map(d => d.count);

    // Gradient: green for high counts tapering to coral for drop-off
    const maxC = Math.max(...counts);
    const colors = counts.map(c => {
        const ratio = maxC > 0 ? c / maxC : 1;
        return ratio > 0.85 ? COLORS.teal : ratio > 0.7 ? COLORS.tealDk : ratio > 0.5 ? COLORS.amber : COLORS.coral;
    });

    const ctx = document.getElementById('funnelChart').getContext('2d');
    if (funnelChart) funnelChart.destroy();
    funnelChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'Leads',
                data: counts,
                backgroundColor: colors,
                borderRadius: 5,
                barPercentage: 0.65,
            }]
        },
        options: {
            ...CHART_DEFAULTS,
            plugins: { ...CHART_DEFAULTS.plugins, legend: { display: false } },
        }
    });
}

document.getElementById('funnel-platform').addEventListener('change', (e) => {
    loadFunnel(e.target.value);
});

/* ── Scoring / Tier ───────────────────────────────── */
async function loadScoring() {
    const res = await fetch('/api/evaluation/scoring');
    const data = await res.json();
    if (data.error) {
        showEmptyState('tierChart', 'No scoring data available');
        return;
    }

    const tiers = data.tier_distribution || {};
    const totalTiers = Object.values(tiers).reduce((s, v) => s + v, 0);
    if (totalTiers === 0) {
        showEmptyState('tierChart', 'No scored leads yet');
        return;
    }
    clearEmptyState('tierChart');
    const tierLabels = {
        auto_enroll: 'Auto-Enroll',
        high_priority_review: 'High Priority',
        standard_priority_review: 'Standard',
        low_priority_review: 'Low Priority',
    };
    const tierColors = [COLORS.emerald, COLORS.teal, COLORS.amber, COLORS.slate];
    const tierKeys = ['auto_enroll', 'high_priority_review', 'standard_priority_review', 'low_priority_review'];

    const ctx = document.getElementById('tierChart').getContext('2d');
    if (tierChart) tierChart.destroy();
    tierChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: tierKeys.map(k => tierLabels[k]),
            datasets: [{
                data: tierKeys.map(k => tiers[k] || 0),
                backgroundColor: tierColors,
                borderWidth: 2,
                borderColor: '#fff',
                hoverOffset: 6,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '58%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { font: { family: 'DM Sans', size: 11, weight: 500 }, color: '#5a6779', boxWidth: 10, padding: 14 }
                }
            }
        }
    });
}

/* ── Trends ──────────────────────────────────────── */
async function loadTrends(platform) {
    const url = '/api/evaluation/trends?days=30' + (platform ? '&platform=' + platform : '');
    const res = await fetch(url);
    const data = await res.json();
    if (data.error) {
        showEmptyState('trendsChart', 'No trend data available');
        return;
    }

    const daily = data.daily || [];
    if (daily.length === 0) {
        showEmptyState('trendsChart', 'No runs in the last 30 days');
        return;
    }
    clearEmptyState('trendsChart');
    const rolling = data.rolling_avg || {};

    const labels = daily.map(d => d.date ? d.date.slice(5) : '');
    const ctx = document.getElementById('trendsChart').getContext('2d');

    if (trendsChart) trendsChart.destroy();
    trendsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [
                {
                    label: 'Found',
                    data: daily.map(d => d.avg_found),
                    borderColor: 'rgba(60,72,88,0.3)',
                    backgroundColor: 'rgba(60,72,88,0.05)',
                    borderWidth: 1.5,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 2,
                },
                {
                    label: 'Scored',
                    data: daily.map(d => d.avg_scored),
                    borderColor: COLORS.teal,
                    backgroundColor: 'rgba(0,178,201,0.08)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 2,
                },
                {
                    label: 'Synced',
                    data: daily.map(d => d.avg_synced),
                    borderColor: COLORS.emerald,
                    backgroundColor: 'rgba(16,185,129,0.08)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 2,
                },
            ]
        },
        options: {
            ...CHART_DEFAULTS,
            plugins: { ...CHART_DEFAULTS.plugins },
        }
    });

    // Benchmark badges
    const badges = document.getElementById('benchmark-badges');
    badges.innerHTML = '';
    if (rolling.avg_found) {
        badges.innerHTML += `<span class="badge badge-muted">30d avg found: ${rolling.avg_found}</span>`;
    }
    if (rolling.avg_scored) {
        badges.innerHTML += `<span class="badge badge-info">30d avg scored: ${rolling.avg_scored}</span>`;
    }
    if (rolling.avg_synced) {
        badges.innerHTML += `<span class="badge badge-success">30d avg synced: ${rolling.avg_synced}</span>`;
    }

    // Baseline reference line on trends chart
    const baseline = data.baseline;
    if (baseline && baseline.avg_scored && trendsChart) {
        const baselinePlugin = {
            id: 'baselineLine',
            afterDraw(chart) {
                const yScale = chart.scales.y;
                const y = yScale.getPixelForValue(baseline.avg_scored);
                const ctx = chart.ctx;
                ctx.save();
                ctx.setLineDash([6, 4]);
                ctx.strokeStyle = 'rgba(0,92,105,0.4)';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.moveTo(chart.chartArea.left, y);
                ctx.lineTo(chart.chartArea.right, y);
                ctx.stroke();
                // Label
                ctx.fillStyle = 'rgba(0,92,105,0.5)';
                ctx.font = '10px DM Sans, sans-serif';
                ctx.fillText('30d baseline', chart.chartArea.right - 65, y - 5);
                ctx.restore();
            }
        };
        trendsChart.config.plugins = [baselinePlugin];
        trendsChart.update();
    }
}

/* ── Benchmarks ────────────────────────────────────── */
async function loadBenchmarks(platform) {
    const url = '/api/evaluation/benchmarks' + (platform ? '?platform=' + platform : '');
    const res = await fetch(url);
    const data = await res.json();
    if (data.error) return;

    const metricsEl = document.getElementById('benchmark-metrics');
    const devsEl = document.getElementById('benchmark-deviations');

    // Find first platform with baseline data
    const platforms = Object.keys(data);
    if (platforms.length === 0) {
        metricsEl.innerHTML = '<div class="text-xs py-4 text-center" style="color:#5a6779;opacity:0.5;">No benchmark data yet — need at least 3 days of snapshots</div>';
        devsEl.innerHTML = '';
        return;
    }

    // Render baseline metric cards
    let cardsHtml = '<div class="grid grid-cols-2 sm:grid-cols-5 gap-3 mb-3">';
    const metricDefs = [
        { key: 'yield_rate', label: 'Yield Rate', suffix: '%' },
        { key: 'avg_found', label: 'Avg Found', suffix: '' },
        { key: 'avg_scored', label: 'Avg Scored', suffix: '' },
        { key: 'avg_synced', label: 'Avg Synced', suffix: '' },
        { key: 'funnel_conversion', label: 'Conversion', suffix: '%' },
    ];

    let hasBaseline = false;
    for (const plat of platforms) {
        const bl = data[plat].baseline;
        if (!bl) continue;
        hasBaseline = true;
        const platLabel = plat.charAt(0).toUpperCase() + plat.slice(1);
        for (const m of metricDefs) {
            const val = bl[m.key] || 0;
            cardsHtml += `<div class="card kpi-card" style="border-top:2px solid #00b2c9;">
                <div class="kpi-label">${m.label}</div>
                <div class="kpi-value">${Math.round(val * 10) / 10}${m.suffix}</div>
                <div class="kpi-sub">${bl.days}d avg · ${platLabel}</div>
            </div>`;
        }
    }
    cardsHtml += '</div>';

    if (!hasBaseline) {
        metricsEl.innerHTML = '<div class="text-xs py-4 text-center" style="color:#5a6779;opacity:0.5;">No benchmark data yet — need at least 3 days of snapshots</div>';
        devsEl.innerHTML = '';
        return;
    }
    metricsEl.innerHTML = cardsHtml;

    // Render recent deviations list
    let allDevs = [];
    for (const plat of platforms) {
        for (const d of (data[plat].deviations || [])) {
            allDevs.push({ ...d, platform: plat });
        }
    }
    allDevs = allDevs.slice(0, 10); // Show last 10

    if (allDevs.length === 0) {
        devsEl.innerHTML = '<div class="text-xs py-2" style="color:#5a6779;opacity:0.5;">No significant deviations detected in recent runs</div>';
        return;
    }

    let devsHtml = '<div class="section-label mb-2">Recent Deviations</div><div class="space-y-1.5">';
    for (const d of allDevs) {
        const isGood = (d.direction === 'above' && d.metric !== 'avg_cost_per_lead') ||
                       (d.direction === 'below' && d.metric === 'avg_cost_per_lead');
        const color = isGood ? '#10b981' : '#f65c4e';
        const bgColor = isGood ? '#d1fae5' : '#fee2e2';
        const sevBadge = d.severity === 'significant'
            ? `<span class="badge" style="background:${bgColor};color:${color};font-size:10px;">significant</span>`
            : '';
        devsHtml += `<div class="flex items-center gap-2 py-1.5 px-3 rounded" style="background:#f9fafb;">
            <span class="text-xs font-medium" style="color:${color};">${Math.abs(d.pct_change)}% ${d.direction}</span>
            <span class="text-xs" style="color:#3c4858;">${d.label}</span>
            <span class="text-xs" style="color:#3c4858;opacity:0.4;">(run ${d.run_value} vs baseline ${d.baseline_value})</span>
            ${sevBadge}
        </div>`;
    }
    devsHtml += '</div>';
    devsEl.innerHTML = devsHtml;

document.getElementById('trends-platform').addEventListener('change', (e) => {
    loadTrends(e.target.value);
});

document.getElementById('bench-platform').addEventListener('change', (e) => {
    loadBenchmarks(e.target.value);
});

/* ── Chart.js loader (works with HTMX boost navigation) ── */
function ensureChartJs() {
    return new Promise((resolve) => {
        if (typeof Chart !== 'undefined') { resolve(); return; }
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
        s.onload = resolve;
        document.head.appendChild(s);
    });
}

/* ── Init ─────────────────────────────────────────── */
async function initEvalCharts() {
    await ensureChartJs();
    loadChannels();
    loadFunnel('');
    loadScoring();
    loadTrends('');
    loadBenchmarks('');
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initEvalCharts);
} else {
    initEvalCharts();
}
})();
}
</script>
-->
{% endblock %}
